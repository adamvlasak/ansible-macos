---
- name: Setup mac
  hosts: all
  vars_files:
    - vars.yml
  vars:
    - renoise_font: FiraCode-Regular.ttf
  tasks:
    - name: Homebrew
      become_user: "{{ user.login }}"
      become: true
      tags:
        - homebrew
      block:
        - name: Install homebrew packages
          community.general.homebrew:
            name: "{{ homebrew.packages }}"
            state: present

        - name: Install homebrew cask packages
          community.general.homebrew_cask:
            name: "{{ homebrew.cask_packages }}"
            state: present

    - name: User
      become_user: "{{ user.login }}"
      become: true
      tags:
        - user
      block:
        - name: Prepare directories
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0700
          loop:
            - "{{ lookup('env', 'HOME') }}/.local/share/mc/skins"
            - "{{ lookup('env', 'HOME') }}/.tmux/plugins"
            - "{{ lookup('env', 'HOME') }}/.vim"
            - "{{ lookup('env', 'HOME') }}/.vim/autoload"
            - "{{ lookup('env', 'HOME') }}/.vim/plugged"

        - name: Download dracula theme for mc
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/dracula/midnight-commander/master/skins/dracula256.ini
            dest: "{{ lookup('env', 'HOME') }}/.local/share/mc/skins/dracula256.ini"
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0600

        - name: Download tmux plugin manager
          ansible.builtin.git:
            repo: https://github.com/tmux-plugins/tpm
            dest: "{{ lookup('env', 'HOME') }}/.tmux/plugins/tpm"
            clone: true
            update: true

        - name: Install vim-plug
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
            dest: "{{ lookup('env', 'HOME') }}/.vim/autoload/plug.vim"
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0600
          when: not ansible_check_mode

        - name: Provision dotfiles
          ansible.builtin.template:
            src: "{{ item }}.j2"
            dest: "{{ lookup('env', 'HOME') }}/.{{ item }}"
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0600
          loop:
            - zshrc
            - gitconfig
            - tmux.conf
            - vimrc

        # osx defaults
        - name: Disable apple press and hold feature
          community.general.osx_defaults:
            domain: NSGlobalDomain
            key: ApplePressAndHoldEnabled
            type: bool
            value: false
            state: present

        - name: Enable fast key repeat
          community.general.osx_defaults:
            domain: NSGlobalDomain
            key: KeyRepeat
            type: int
            value: 2
            state: present

        - name: Enable fast initial key repeat
          community.general.osx_defaults:
            domain: NSGlobalDomain
            key: InitialKeyRepeat
            type: int
            value: 20
            state: present

        - name: Enable vs code key repeat
          community.general.osx_defaults:
            domain: com.microsoft.VSCode
            key: ApplePressAndHoldEnabled
            type: bool
            value: false
            state: present

        # enables Home and End keys in some apps
        - name: Setup keybinding directory
          ansible.builtin.file:
            path: "{{ lookup('env', 'HOME') }}/Library/KeyBindings"
            state: directory
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0700

        - name: Setup keybinding dict
          ansible.builtin.template:
            src: DefaultKeyBinding.dict.j2
            dest: "{{ lookup('env', 'HOME') }}/Library/KeyBindings/DefaultKeyBinding.dict"
            owner: "{{ user.login }}"
            group: "{{ user.group }}"
            mode: 0600

    - name: Renoise
      become_user: "{{ user.login }}"
      become: true
      tags:
        - renoise
      block:
        - name: Copy FiraCode font file to Renoise app directory
          ansible.builtin.copy:
            src: "{{ renoise_font }}"
            dest: "/Applications/Renoise.app/Contents/Resources/Skin/Fonts/{{ renoise_font }}"

        - name: Change Config.xml to use our FiraCode font
          ansible.builtin.template:
            src: "{{ item }}.j2"
            dest: "/Applications/Renoise.app/Contents/Resources/Skin/Fonts/{{ item }}"
          loop:
            - Config.xml
            - PatternConfig.xml
